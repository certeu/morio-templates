{{#MORIO_DOCS}}
about: |-
  A filebeat module for Linux systems

  This collects access log data from the Apache 2.x HTTP Server. It autodetects and supports the following log file formats:
  - common
  - combined
  - vhost_combined
  If the logs are to be sent to a Splunk ecosystem, you can set the MORIO_APACHE_SPLUNK_INDEX_NAME Morio variable to specify the name of the Splunk index to use.
{{/MORIO_DOCS}}

{{^MORIO_DOCS}}

# This module collects all Apache logs
- type: log
  id: apache2_everything
  paths:
    - /var/log/apache2/*.log

  processors:
    - add_fields:
        target: morio
        fields:
          module: {{ MORIO_MODULE_NAME }}

    - add_fields:
        target: host
        fields:
          id: {{ MORIO_CLIENT_UUID }}

    - add_fields:
        target: debug
        fields:
          iteration: "1543"

    - if:
        regexp:
          message: '^[^:].*:\d{1,3} ' # LogFormat vhost_combined
      then:
        - dissect:
            field: "message"
            tokenizer: "%{http.server.name}:%{http.server.port} %{source.ip} %{http.auth_type} %{http.username} [%{temp_timestamp}] \"%{http.request.method} %{url.original} %{http.version}\" %{http.response.status_code} %{http.response.body.bytes} \"%{url.original}\" \"%{user_agent.original}\""
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
        - add_fields:
            target: log
            fields:
              detected_format: "vhost_combined"
        - timestamp:
            field: temp_timestamp
            layouts:
              - '02/Jan/2006:15:04:05 -0700'
            ignore_missing: true
            ignore_failure: true
        - drop_fields:
            fields: temp_timestamp
            ignore_missing: true

    - if:
        regexp:
          message: '^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3} .+ \d+ \d+ .+$' # LogFormat combined
      then:
        - dissect:
            field: "message"
            tokenizer: "%{source.ip} %{http.auth_type} %{http.username} [%{temp_timestamp}] \"%{http.request.method} %{url.original} %{http.version}\" %{http.response.status_code} %{http.response.body.bytes} \"%{url.original}\" \"%{user_agent.original}\""
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
        - add_fields:
            target: log
            fields:
              detected_format: "combined"
        - timestamp:
            field: temp_timestamp
            layouts:
              - '02/Jan/2006:15:04:05 -0700'
            ignore_missing: true
            ignore_failure: true
        - drop_fields:
            fields: temp_timestamp
            ignore_missing: true

    - if:
        regexp:
          message: '^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3} .+ \d+ \d+$' # LogFormat common
      then:
        - dissect:
            field: "message"
            tokenizer: "%{source.ip} %{http.auth_type} %{http.username} [%{temp_timestamp}] \"%{http.request.method} %{url.original} %{http.version}\" %{http.response.status_code} %{http.response.body.bytes}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
        - add_fields:
            target: log
            fields:
              detected_format: "common"
        - timestamp:
            field: temp_timestamp
            layouts:
              - '02/Jan/2006:15:04:05 -0700'
        - drop_fields:
            fields: temp_timestamp
            ignore_missing: true

    {{#MORIO_APACHE_SPLUNK_INDEX_NAME }}
    - add_fields:
        target: splunk
        fields:
          index: {{ MORIO_APACHE_SPLUNK_INDEX_NAME }}
    {{/MORIO_APACHE_SPLUNK_INDEX_NAME }}

{{/MORIO_DOCS}}

