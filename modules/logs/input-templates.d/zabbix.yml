# This software is provided "as is" and any express or implied warranties, including,
# but not limited to, the implied warranties of merchantability and fitness for a
# particular purpose are disclaimed. In no event shall the authors or copyright holders
# be liable for any claim, damages or other liability, whether in an action of contract,
# tort or otherwise, arising from, out of or in connection with the software or the use
# or other dealings in the software.
#
# The software is provided under the European Union Public Licence (EUPL) version 1.2;
# you may not use this file except in compliance with the License. You may obtain a copy
# of the License at:
#
#     https://joinup.ec.europa.eu/collection/eupl/eupl-text-eupl-12
#
# Unless required by applicable law or agreed to in writing, software distributed under
# the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the specific language governing
# permissions and limitations under the License.

{{#MORIO_DOCS}}
about: |-
  A filebeat module for Linux systems

  This collects log data from the Zabbix package (both from the agent and from the server packages, if installed). 

  If the logs are to be sent to a Splunk ecosystem, you can set the MORIO_ZABBIX_SPLUNK_INDEX_NAME Morio variable to specify the name of the Splunk index to use.
{{/MORIO_DOCS}}

{{^MORIO_DOCS}}

- type: log # Zabbix agent logs
  id: zabbix_agent
  paths:
    - /var/log/zabbix-agent/zabbix_agentd.log

  processors:
    - add_fields:
        target: morio
        fields:
          module: {{ MORIO_MODULE_NAME }}

    - add_fields:
        target: host
        fields:
          id: {{ MORIO_CLIENT_UUID }}

    - add_fields:
        target: debug
        fields:
          iteration: "ZA-AI"

    - if:
        regexp:
          message: '^[ \d]+:\d{8}:\d{6}.\d{3}\s' # default log format
      then:
        - dissect:
            field: "message"
            tokenizer: "%{process.pid}:%{temp_timestamp} %{event.message}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
            trim_values: left # as the PID can have spaces
        - add_fields:
            target: log
            fields:
              detected_format: "default"
        - add_fields:
            target: event
            fields:
              type: "agent"
        - add_fields:
            target: service
            fields:
              name: "Zabbix Agent"

    - timestamp:
        field: temp_timestamp
        layouts:
          - '20060102:150405.999'
        timezone: Local
    - drop_fields:
        fields: temp_timestamp


- type: log # Zabbix server logs
  id: zabbix_server
  paths:
    - /var/log/zabbix/zabbix_server.log

  processors:
    - add_fields:
        target: morio
        fields:
          module: {{ MORIO_MODULE_NAME }}

    - add_fields:
        target: host
        fields:
          id: {{ MORIO_CLIENT_UUID }}

    - add_fields:
        target: debug
        fields:
          iteration: "ZS-AA"

    - if:
        regexp:
          message: '^[ \d]+:\d{8}:\d{6}.\d{3}\s' # default log format
      then:
        - dissect:
            field: "message"
            tokenizer: "%{process.pid}:%{temp_timestamp} %{event.message}"
            target_prefix: ''
            ignore_missing: true
            ignore_failure: true
            overwrite_keys: true
            trim_values: left # as the PID can have spaces
        - add_fields:
            target: log
            fields:
              detected_format: "default"
        - add_fields:
            target: event
            fields:
              type: "server"
        - add_fields:
            target: service
            fields:
              name: "Zabbix Server"

    - timestamp:
        field: temp_timestamp
        layouts:
          - '20060102:150405.999'
        timezone: Local
    - drop_fields:
        fields: temp_timestamp

    {{#MORIO_ZABBIX_SPLUNK_INDEX_NAME }}
    - add_fields:
        target: splunk
        fields:
          index: {{ MORIO_ZABBIX_SPLUNK_INDEX_NAME }}
    {{/MORIO_ZABBIX_SPLUNK_INDEX_NAME }}

{{/MORIO_DOCS}}

